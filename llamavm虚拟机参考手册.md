# llamavm虚拟机参考手册

---

llamavm是一个基于lua语言设计开发的虚拟机，这里说的虚拟机不是vmware这种运行各类操作系统的软件，而是类似于jvm、.net-framework、python、JavaScript-v8等提供高级语言运行环境的基础软件。

各种语言的虚拟机实现不尽相同，差异点如下：
> （1）是否提供系统os功能？

lua语言不提供任何os相关的功能，比如多线程、socket等，仅限c标准库支持的功能。
**优点**是可移植性强，在任意支持ansi c的系统上都可以编译运行，包括嵌入式设备、游戏主机、手机系统、服务器等。
**缺点**是需要借助第三方库实现os相关的功能，不便于开发复杂系统。

java、python、.net都提供os相关功能，几乎将系统api全部封装了一遍。
**优点**是使用方便，不需要了解系统api。
**缺点**是可移植性差，对于每个系统都需要定制开发一套安装包，比如.net只支持Windows系统。

> （2）编译型还是解释型？

语言可分为编译型和解释型两种，但现在已经很难分清是编译型还是解释型，甚至可以说所有语言都是解释型，差异就是cpu解释还是虚拟机解释。真正需要关心的是，生成的指令究竟是机器指令还是中间字节码指令。

c、c++、golang直接生成机器指令，lua、python、java、c#生成字节码指令，但也有可能直接生成机器指令，如各类jit版本的编译器，如luajit、HotSpot VM、JavaScript v8等。

jit版本执行性能更高，常常比原生版本快上好几倍，但由于和机器绑定，需要每个系统定制一套。

> （3）基于堆栈还是寄存器的指令？

以计算 ``` 1+2+3 ```为例，基于堆栈的处理方法是每次计算都先将数据压栈，计算完成后再弹出，指令如下：
```
push 1
push 2
push 3
add
```


基于寄存器的处理方法是获取每个数据的地址，直接计算，指令如下：
```
add 1 2 3
```

特点比较：

基于堆栈：**优点**是指令简单，每条指令只需要1个byte，故称字节码指令。**缺点**是指令量大，不容易优化。

基于寄存器：**优点**是指令量少，容易精简指令。**缺点**是实现起来比较困难，单条指令更长。

目前大部分虚拟机都是基于堆栈实现的，仅有lua5.0、Android Dalvik虚拟机基于寄存器实现。**llamavm**是基于堆栈实现的虚拟机，因为简单。

